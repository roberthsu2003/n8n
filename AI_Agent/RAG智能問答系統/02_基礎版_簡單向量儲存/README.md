# 📁 RAG 基礎版 - 簡單向量儲存

## 📖 什麼是這個範例？

這是 **進階的 RAG 實作**，使用 **Simple Vector Store** 實現資料持久化儲存，並支援多來源文件整合。

這個版本包含 **4 個獨立工作流程**：
- 📤 **Workflow 1A**：本機檔案上傳索引
- ☁️ **Workflow 1B**：Google Drive 自動同步
- 💬 **Workflow 2A**：基礎版智能問答
- 🎯 **Workflow 2B**：進階版問答（來源過濾）

## ✨ 與入門版的差異

| 特性 | 入門版 | 基礎版 |
|------|--------|--------|
| **資料持久性** | ❌ 執行後消失 | ✅ 永久儲存 |
| **工作流程數量** | 1 個（整合式） | 4 個（分離式） |
| **文件來源** | 單一上傳 | 多來源（本機 + Google Drive） |
| **來源追蹤** | ❌ 不支援 | ✅ 支援來源過濾 |
| **適用規模** | 小（<50 文件） | 中（<1000 文件） |
| **適用場景** | 學習測試 | 實際應用 |

## 🎯 核心優勢

### **1. 資料持久化**
- 📦 **Simple Vector Store**：向量資料儲存在本地檔案中
- 🔄 **跨流程共用**：索引一次，隨時查詢
- 💾 **不會消失**：重啟工作流程資料仍然存在

### **2. 分離式架構**

```
┌─────────────────────────────────────────────┐
│          分離式架構優勢                      │
├─────────────────────────────────────────────┤
│                                             │
│  索引流程（建立一次）                        │
│  ├─ Workflow 1A: 本機上傳                   │
│  └─ Workflow 1B: Google Drive 同步          │
│         ↓                                   │
│  ┌──────────────────┐                       │
│  │ Simple Vector Store│                      │
│  │  (持久化儲存)      │                      │
│  └──────────────────┘                       │
│         ↓                                   │
│  查詢流程（隨時使用）                        │
│  ├─ Workflow 2A: 基礎問答                   │
│  └─ Workflow 2B: 來源過濾問答               │
│                                             │
└─────────────────────────────────────────────┘
```

**優勢**：
- ✅ 索引和查詢分離，更有效率
- ✅ 可以隨時新增文件，不影響問答
- ✅ 支援多個查詢介面同時使用
- ✅ 更容易維護和擴展

### **3. 多來源整合**

**本機上傳（Workflow 1A）**
- 📤 提供網頁表單上傳
- 🎯 適合：臨時文件、個人資料

**Google Drive 同步（Workflow 1B）**
- ☁️ 自動從 Google Drive 同步
- 🔄 支援排程（每天自動更新）
- 📁 適合：團隊共用知識庫

### **4. 來源過濾（Workflow 2B）**

**智能識別查詢意圖**：
```
使用者問：「從本機檔案查詢產品規格」
系統識別：source_filter = "local_upload"
只搜尋：本機上傳的文件

使用者問：「從 Google Drive 查詢公司政策」
系統識別：source_filter = "google_drive"
只搜尋：Google Drive 的文件

使用者問：「什麼是 RAG？」
系統識別：source_filter = "all"
搜尋：全部文件
```

---

## 📦 包含的檔案

### **工作流程檔案**

1. **01_RAG文件索引_本機上傳.json**
   - 提供網頁表單上傳文件
   - 支援 PDF、Word、TXT 格式
   - 自動建立向量索引並儲存

2. **02_RAG文件索引_Google_Drive同步.json**
   - 從 Google Drive 資料夾同步文件
   - 支援排程自動執行
   - 保留完整檔案元資料

3. **03_RAG智能問答_基礎版.json**
   - 簡單易用的對話介面
   - 搜尋全部文件
   - 適合快速部署

4. **04_RAG智能問答_進階版_來源過濾.json**
   - 支援來源過濾功能
   - 智能識別查詢意圖
   - 更詳細的系統提示

### **測試資料檔案**

- `產品資訊.md` / `產品資訊.pdf`：測試用產品資料
- `說明書.txt`：測試用說明文件
- `快速參考卡.md`：快速參考資料

### **文件檔案**

- `README.md`（本檔案）：概覽和快速開始
- `完整使用指南.md`：詳細的使用說明、參數調整、問題排除

---

## 🚀 快速開始

### **前置需求**

- ✅ n8n 帳號（本地安裝或雲端版）
- ✅ Google Gemini API Key（[免費申請](https://aistudio.google.com/app/apikey)）
- ✅ Google Drive OAuth2 憑證（選用，僅 Workflow 1B 需要）

### **步驟 1：匯入工作流程**

1. 依序匯入 4 個 JSON 檔案到 n8n
2. 確認所有工作流程都成功匯入

### **步驟 2：設定憑證**

#### **Google Gemini API**（全部流程都需要）

1. 前往 https://aistudio.google.com/app/apikey
2. 建立新的 API Key
3. 在 n8n 中新增 `Google Gemini` 憑證
4. 貼上 API Key 並儲存

#### **Google Drive OAuth2**（僅 Workflow 1B 需要）

1. 在 n8n 中新增 `Google Drive OAuth2` 憑證
2. 依照提示完成 OAuth2 授權流程
3. 測試連線確認成功

### **步驟 3：建立文件索引**

#### **選項 A：上傳本機檔案**

1. 開啟 **Workflow 1A**
2. 點擊 `📤 表單觸發器` 節點
3. 複製 **Production URL**
4. 在瀏覽器開啟該網址
5. 上傳您的文件（可使用提供的測試檔案）
6. 等待處理完成

#### **選項 B：同步 Google Drive**

1. 開啟 **Workflow 1B**
2. 點擊 `📂 列出 Google Drive 檔案` 節點
3. 選擇要同步的資料夾
4. 點擊 **Test workflow** 測試執行
5. 確認檔案成功索引
6. 啟用排程（可選，例如每天自動同步）

### **步驟 4：開始問答**

#### **基礎版問答**

1. 開啟 **Workflow 2A**
2. 點擊 `💬 Chat Trigger` 節點
3. 複製 **Chat URL**
4. 在瀏覽器開啟對話介面
5. 開始提問！

#### **進階版問答（來源過濾）**

1. 開啟 **Workflow 2B**
2. 取得對話介面網址
3. 測試不同的查詢方式：
   - 「什麼是 RAG？」（搜尋全部）
   - 「從本機檔案查詢產品功能」（只搜尋上傳的檔案）
   - 「從 Google Drive 查詢公司政策」（只搜尋雲端檔案）

---

## 💡 核心概念

### **1. Simple Vector Store**

**什麼是 Simple Vector Store？**

Simple Vector Store 是 n8n 內建的輕量級向量資料庫，特點是：
- 📦 **檔案儲存**：資料儲存在本地檔案中
- 💾 **持久化**：重啟不會消失
- 🔑 **Key-Value**：使用 Key 區分不同的向量空間
- 🆓 **零成本**：不需要外部服務

**儲存位置**：
```
n8n 資料目錄/
└── vectorStore/
    └── [vector_key]/
        └── docstore.json
```

**Memory Key 的作用**：

在這個範例中，我們使用 `vector_store_key` 作為共用的 Memory Key：

```
Workflow 1A (Insert) ──┐
                        ├──> vector_store_key
Workflow 1B (Insert) ──┘

Workflow 2A (Retrieve) ─┐
                         ├──> vector_store_key
Workflow 2B (Retrieve) ─┘
```

**重要**：所有工作流程必須使用**相同的 Memory Key**，才能存取同一個向量空間！

### **2. 分離式架構的優勢**

**為什麼要分離索引和查詢？**

| 方面 | 整合式（入門版） | 分離式（基礎版） |
|------|-----------------|-----------------|
| **索引效率** | 每次上傳都重建整個索引 | 只添加新文件 |
| **查詢效率** | 需要等待索引完成 | 隨時可以查詢 |
| **維護性** | 難以管理文件 | 可以分別維護 |
| **擴展性** | 難以添加新來源 | 容易添加新來源 |

### **3. 來源過濾的實作原理**

**Workflow 2B** 的智能來源識別流程：

```
1. 使用者輸入問題
   ↓
2. AI 分析問題意圖
   - 包含「本機」、「上傳」→ local_upload
   - 包含「Google Drive」、「雲端」→ google_drive
   - 其他 → all
   ↓
3. 根據 source_filter 執行不同的檢索策略
   ↓
4. 生成答案並標註來源
```

---

## 🔧 參數調整

### **提升答案準確度**

**調整 Top K**（檢索數量）
- 位置：`🔍 Vector Store Tool` 節點
- 參數：`Top K`
- 預設：4
- 建議：6-8（更多上下文，但增加 Token 使用）

**降低 Temperature**（減少隨機性）
- 位置：`🧠 Google Gemini Chat Model` 節點
- 參數：`Temperature`
- 預設：0.3
- 建議：0.2（更準確但較死板）

### **處理較長文件**

**調整 Chunk Size**（分割大小）
- 位置：`✂️ 遞迴字元分割器` 節點
- 參數：`Chunk Size`
- 預設：800
- 建議：1000-1200（較長文件）

**調整 Overlap**（重疊部分）
- 參數：`Chunk Overlap`
- 建議：維持 Chunk Size 的 20-25%

---

## 🎯 測試建議

### **基礎測試**

```markdown
✅ 測試 1：上傳本機檔案
- 上傳 `產品資訊.pdf`
- 問：「這個產品的主要功能是什麼？」

✅ 測試 2：同步 Google Drive
- 設定 Google Drive 資料夾
- 執行 Workflow 1B
- 確認檔案成功索引

✅ 測試 3：基礎問答
- 使用 Workflow 2A
- 測試一般性問題
- 確認答案來自文件內容

✅ 測試 4：來源過濾
- 使用 Workflow 2B
- 問：「從本機檔案查詢...」
- 檢查執行日誌的 source_filter 值
```

---

## ❓ 常見問題

### **Q1: 如何確認資料已經儲存？**

**方法 1**：檢查執行日誌
- 執行 Workflow 1A 或 1B
- 查看 Vector Store 節點的輸出
- 確認有 "Successfully inserted" 訊息

**方法 2**：測試查詢
- 執行 Workflow 2A
- 提出一個文件中肯定有的問題
- 如果能正確回答，表示資料已儲存

### **Q2: 多個工作流程如何共用同一個向量空間？**

**關鍵**：確保所有工作流程使用**相同的 Memory Key**

1. 檢查所有 Vector Store 節點
2. 確認 `Memory Key` 都設為 `vector_store_key`
3. 如果不同，手動修改為相同值

### **Q3: 如何清空向量資料庫？**

**方法 1**：透過 n8n 資料目錄
```bash
# 找到 n8n 資料目錄
# 刪除對應的 vectorStore 資料夾
rm -rf ~/.n8n/vectorStore/vector_store_key/
```

**方法 2**：更換 Memory Key
- 修改所有工作流程的 Memory Key
- 例如改為 `vector_store_key_v2`
- 舊資料仍存在，但不會被讀取

### **Q4: Workflow 1B 無法同步 Google Drive？**

**檢查清單**：
- [ ] OAuth2 憑證是否正確設定
- [ ] 是否已授權 n8n 存取 Google Drive
- [ ] 資料夾 ID 是否正確
- [ ] 資料夾權限是否允許讀取

### **Q5: 來源過濾（Workflow 2B）無法正常工作？**

**可能原因**：
1. 文件索引時未正確標記來源
2. AI 無法正確識別查詢意圖

**解決方法**：
1. 檢查 Workflow 1A/1B 的 metadata 設定
2. 確認有添加 `source` 欄位
3. 優化 System Prompt，提供更明確的指示

---

## 📚 學習路徑

### **完成這個範例後，您已經學會：**

✅ 資料持久化儲存的實作  
✅ 分離式架構的設計與優勢  
✅ 多來源文件整合（本機 + Google Drive）  
✅ 來源追蹤和過濾機制  
✅ Simple Vector Store 的使用與管理

### **與入門版的知識累積：**

| 概念 | 入門版 | 基礎版 |
|------|--------|--------|
| **RAG 基礎** | ✅ 已學習 | ✅ 更深入理解 |
| **Embeddings** | ✅ 已學習 | ✅ 實際應用 |
| **Vector Store** | ✅ In-Memory | ✅ Simple（持久化） |
| **架構設計** | ❌ 整合式 | ✅ 分離式 |
| **多來源整合** | ❌ 無 | ✅ 已掌握 |

### **下一步學習建議：**

1. **☁️ 進階版 - 雲端向量資料庫**
   - 使用 Pinecone、Qdrant 等專業資料庫
   - 學習大規模文件管理（數千至數萬份）
   - 企業級應用設計與最佳實踐
   - 進階功能：混合搜尋、重排序、權限管理

---

## 📖 詳細文件

本資料夾包含以下文件：

1. **README.md**（本檔案）
   - 概覽和快速開始
   - 核心概念說明
   - 常見問題

2. **完整使用指南.md**
   - 詳細的設定步驟
   - 參數調整指南
   - 測試建議
   - 問題排除
   - 教學規劃

3. **快速參考卡.md**
   - 快速查詢的命令和設定
   - 常用參數列表

---

## 🎓 教學建議

### **教學流程（2 堂課，共 120 分鐘）**

#### **第 1 堂課：索引建置（60 分鐘）**

1. **回顧入門版**（10 分鐘）
   - 複習 RAG 基本概念
   - 說明入門版的限制
   - 引入持久化儲存的需求

2. **Simple Vector Store 講解**（15 分鐘）
   - 什麼是 Simple Vector Store
   - 與 In-Memory 的差異
   - Memory Key 的作用
   - 分離式架構的優勢

3. **實作 Workflow 1A**（20 分鐘）
   - 匯入工作流程
   - 設定憑證
   - 上傳測試文件
   - 確認資料持久化

4. **實作 Workflow 1B**（選用，15 分鐘）
   - 設定 Google Drive 憑證
   - 選擇同步資料夾
   - 執行同步測試

#### **第 2 堂課：智能問答（60 分鐘）**

1. **實作 Workflow 2A**（20 分鐘）
   - 匯入基礎版問答
   - 測試基本查詢
   - 確認能讀取已索引的文件

2. **實作 Workflow 2B**（25 分鐘）
   - 匯入進階版問答
   - 講解來源過濾機制
   - 測試不同的查詢方式
   - 檢查執行日誌

3. **參數調整與優化**（10 分鐘）
   - 調整 Top K 和 Temperature
   - 觀察答案品質變化
   - 討論不同場景的最佳設定

4. **總結與討論**（5 分鐘）
   - 比較入門版、基礎版的差異
   - 討論實際應用場景
   - 預告進階版（雲端向量資料庫）

---

## 🎉 完成檢查清單

### **初次部署**
- [ ] 4 個工作流程都已匯入
- [ ] Google Gemini 憑證已設定
- [ ] （選用）Google Drive 憑證已設定
- [ ] Workflow 1A 上傳表單可以開啟
- [ ] 測試上傳一個檔案並確認成功
- [ ] Workflow 2A 對話介面可以開啟
- [ ] 測試一個簡單問題並得到正確答案

### **進階功能**
- [ ] Workflow 1B Google Drive 同步測試成功
- [ ] 設定自動排程（每天同步）
- [ ] Workflow 2B 來源過濾功能正常
- [ ] 測試「從本機檔案查詢...」
- [ ] 測試「從 Google Drive 查詢...」
- [ ] 檢查執行日誌確認 source_filter 正確

### **優化調整**
- [ ] 根據實際使用調整 Top K 值
- [ ] 根據答案品質調整 Temperature
- [ ] 根據文件長度調整 Chunk Size
- [ ] 測試多種問題類型並評估準確度

---

**🎓 恭喜完成 RAG 基礎版！您已經掌握了實用的 RAG 系統設計。**

**💡 下一步**：準備好挑戰 [進階版](../03_進階版_雲端向量資料庫/README.md) 了嗎？學習企業級的雲端向量資料庫應用！

---

## 📞 需要幫助？

- 📖 查看 [完整使用指南](./完整使用指南.md) 了解詳細資訊
- 🔙 回到 [入門版](../01_入門版_記憶體儲存/README.md) 複習基礎概念
- 📚 查看 [RAG 系列總覽](../README.md) 了解整體學習路徑
